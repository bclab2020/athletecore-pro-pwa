# AthleteCore Pro - AI姿勢分析システム

## 🎯 プロジェクト概要
AI MediaPipeを活用したリアルタイム姿勢分析PWA（Progressive Web App）。アスリートの姿勢・動作分析を提供し、パフォーマンス向上をサポートします。

## 🏆 **最新アップデート（2025年1月）**
- **📸 黒画像問題完全修正** - インカメラ撮影時の黒画像問題を解決
- **🎯 カメラタイプ検出強化** - 複数手法による確実なインカメラ判定
- **⚡ ビデオ準備状態検証** - フレームデータ確認による確実な撮影
- **🧪 リアルタイムデバッグ機能** - 即座に撮影テストが可能
- **🔧 包括的トラブルシューティング** - 詳細な動作状況確認
- **🎯 オーバーレイ位置修正** - 撮影画像での骨格点・線の完全整列
- **📏 mm単位精密測定** - 肩・腰傾斜のリアル単位測定システム
- **🔄 スマートリロード根本修正** - 初期化競合問題を完全解決、確実な画面復元
- **🌟 透明レイヤーUI実装** - カメラ全画面に美しい透明オーバーレイを導入
- **🎬 撮影時MediaPipe継続** - カウントダウン中も骨格認識が継続動作する修正
- **📱 撮影時フルスクリーン表示** - 撮影中は完全な全画面カメラ表示で立ち位置確認が明確
- **🛡️ MediaPipe安定性強化** - 撮影中のクラッシュ防止、自動エラー回復、包括的エラーハンドリング実装
- **⚡ カウントダウン最適化** - 9秒後（カウント1）で撮影実行、10秒後（カウント0）で視覚効果のタイムラグ解消
- **📱 スクロール不要TOP画面** - ウェルカム画面を均等バランス配置でスクロール不要のレイアウトに最適化
- **🎨 半透明レイヤーデザイン** - アスリート向けウェルカム画面にグラスモーフィズムデザインを実装、洗練された未来的UI
- **🏆 Dior Sportスタイル** - ラグジュアリースポーツブランド風の洗練されたデザインシステムを全面採用、ミニマリスト・エレガンス・プレミアム感を演出
- **🎨 全画面統一デザイン** - ウェルカム・ダッシュボード・分析・結果画面すべてにDior Sport美学を適用、完璧な統一感とブランド体験を実現

## ✅ 実装完了機能

### 1. **基本PWA機能**
- Progressive Web App対応（マニフェスト、サービスワーカー）
- オフライン対応・ホーム画面へのインストール可能
- レスポンシブデザイン（モバイル最適化）
- セーフエリア対応（iPhone対応）

### 2. **MediaPipe AI姿勢検出**
- **リアルタイム33点骨格ランドマーク検出**
- フロント/バックカメラ切り替え対応
- **高精度姿勢オーバーレイ表示**（骨格線・垂直基準線）
- カメラ映像のミラーリング対応（フロントカメラ）
- **🌟 透明レイヤーUI** - 美しいガラスモーフィズム効果でシームレスなカメラ体験
- **📱 撮影時フルスクリーン** - カウントダウン・録画中は完全な全画面表示で立ち位置確認が明確
- **🛡️ 高度エラー回復機能** - MediaPipe停止時の自動回復、アプリクラッシュ防止、安定性監視システム
- **⚡ ゼロラグ撮影** - 9秒後（カウント1）で内部撮影実行、10秒後（カウント0）で効果表示のタイムラグ解消
- **📱 完璧な初期画面** - スクロール不要の均等バランス配置、全デバイス対応の最適化されたウェルカム体験

### 3. **分析機能**
- **Static Analysis（静的姿勢分析）**: ドラマティック10秒カウントダウン付き（⚡ゼロラグ撮影）
- **Dynamic Analysis（動的動作分析）**: AI自動動作検出・15秒録画
- **リアルタイムスクワット検出・カウント**
- **垂直基準線による姿勢偏差測定**（パーセンテージ表示）
- **📱 自動フルスクリーンモード** - 撮影開始と同時に全画面カメラ表示、撮影完了で元の表示に復帰

### 4. **📸 写真撮影・保存機能** ✅ **NEW!**
- **分析実行時の自動写真撮影**
- **姿勢オーバーレイ付き写真保存**（骨格線・基準線込み）
- **Base64エンコーディング**によるローカルストレージ保存
- **インテリジェント容量管理**（8MB制限、自動クリーンアップ）
- **フロントカメラ画像の自動正規化**（ミラー効果補正）

### 5. **📊 分析履歴・詳細表示** ✅ **ENHANCED!**
- **日付別グループ化タイムライン表示**
- **高度なフィルタリング機能**（All/Static/Dynamic）
- **📸 写真付き分析詳細ビュー**
- **フルスクリーン写真モーダル**
- **写真ダウンロード・共有機能**
- **詳細なパフォーマンス分析チャート**

### 6. **🔄 写真比較機能** ✅ **NEW!**
- **Before/After写真比較**
- **スコア改善の詳細可視化**
- **進捗分析レポート自動生成**
- **改善度合いの数値化表示**

### 7. **🔄 スマートリロード機能** ✅ **完全修正!**
- **MediaPipe自動停止検出** - 骨格認識が10秒停止したら自動警告
- **ワンタッチリロードボタン** - 撮影画面の右上に赤いリロードボタン
- **ユーザーデータ保持** - リロード後も分析履歴・設定を完全保持
- **根本修正済み状態復元** - 初期化競合を解決、100%確実な分析画面復帰
- **競合回避システム** - 通常の初期化プロセスとの干渉を完全防止
- **高速復元** - 100ms以内での即座画面切り替え
- **復旧成功通知** - リロード完了時に緑色のトースト通知表示

### 8. **🎵 マルチモーダルフィードバック**
- **多言語音声ガイダンス**（英語、フロントカメラ使用時）
- **Web Audio API高品質効果音**
- **段階的ハプティックフィードバック**（振動パターン）
- **ビジュアルカウントダウン効果**

### 8. **📏 精密mm測定システム** ✅ **NEW!**
- **実寸法測定** - 骨格点12,13（肩）と23,24（腰）の水平傾斜をmm単位で測定
- **3重校正システム** - 肩幅・腰幅・胴体高による多点校正で高精度変換
- **写真オーバーレイ** - 撮影画像に測定値と評価を自動表記
- **5段階評価** - 理想的(<5mm)〜高度傾斜(50mm+)の詳細評価
- **信頼性表示** - 校正品質と信頼度をパーセンテージで表示

### 9. **⚽ 競技特化分析**
- **5競技対応**（サッカー、バスケ、野球、卓球、バレー）
- **競技別スコア基準・推奨事項**
- **パフォーマンス指標の競技特化**

## 🔧 技術スタック
- **Frontend**: HTML5, CSS3 (Tailwind), JavaScript (ES6+)
- **AI/ML**: MediaPipe Pose Detection
- **Visualization**: Chart.js (レーダーチャート)
- **Camera**: WebRTC getUserMedia API
- **Storage**: localStorage (写真データ含む)
- **Audio**: Web Speech API, Web Audio API

## 📸 写真機能の詳細

### 撮影タイミング
- **Static Analysis**: 10秒カウントダウン（⚡9秒後のカウント1で撮影実行、10秒後のカウント0で効果表示）
- **Dynamic Analysis**: 15秒動作録画終了時、自動撮影

### 写真データ構造
```javascript
{
  imageData: "data:image/jpeg;base64,/9j/4AAQ...", // Base64画像データ
  width: 640,                                      // 画像幅
  height: 480,                                     // 画像高さ
  timestamp: "2025-01-09T12:34:56.789Z",         // 撮影時刻
  hasPoseOverlay: true,                           // 姿勢オーバーレイ有無
  cameraType: "front",                            // カメラタイプ
  mmMeasurements: {                               // mm測定データ（NEW!）
    calibration: {
      pixelToMmRatio: 2.847,                      // ピクセル→mm変換係数
      calibrationQuality: "excellent",            // 校正品質
      confidence: 0.89                            // 信頼度
    },
    measurements: {
      shoulderAlignment: {
        deviationMm: 12.4,                        // 肩の傾斜(mm)
        higherShoulder: "right",                  // 高い肩
        assessment: {
          level: "moderate",                      // 評価レベル
          text: "軽度傾斜",                       // 評価テキスト
          color: "#F59E0B"                        // 表示色
        }
      },
      hipAlignment: {
        deviationMm: 8.7,                         // 腰の傾斜(mm)
        higherHip: "left",                        // 高い腰
        assessment: { /* 同様の評価構造 */ }
      }
    }
  }
}
```

### ストレージ管理
- 最大8MB制限
- 古い写真データを優先的に削除
- 容量不足時は写真なしで分析データのみ保存

## 🛠️ **包括的デバッグシステム** ✅ **NEW!**

### **リアルタイムデバッグコマンド**
ブラウザコンソールで以下のコマンドが利用可能：

```javascript
// 📊 分析履歴とデータ状況の詳細確認
debugAnalysisHistory()
// → 写真データの有無、サイズ、エントリ数などを表示

// 📸 写真キャプチャーの包括的状況確認
debugPhotoCapture()
// → 写真付き/なしのエントリ数、サンプル写真データなど

// 📹 ビデオストリーム詳細状態確認（NEW!）
debugVideoStatus()
// → 全ビデオ要素の詳細状態、準備度、カメラタイプを確認

// 📸 リアルタイム写真撮影テスト（NEW!）
debugCaptureNow()
// → 現在アクティブなカメラで即座に写真撮影・結果確認

// 📹 カメラとポーズ検出のリアルタイム状態
debugCameraState()
// → ビデオサイズ、準備状況、ポーズ検出状況

// 🧪 特定分析の詳細表示テスト
testAnalysisDetail('analysis_id_here')
// → 指定IDの分析詳細を強制表示

// 📏 mm測定システムテスト（NEW!）
debugMmMeasurements()
// → 現在の姿勢でmm測定の校正・精度・結果を確認

// 📸 mm測定付き写真撮影テスト（NEW!）
debugPhotoWithMm()
// → mm測定データ付きで写真撮影・オーバーレイ確認

// 🎯 オーバーレイ位置整列テスト（NEW!）
debugOverlayAlignment()
// → 骨格点・線の写真内位置精度を詳細検証

// 🎯 テスト用写真サンプルの即座作成
debugCreatePhotoSample()
// → 写真付きサンプルデータを作成してテスト表示

// 🔄 スマートリロード機能テスト（NEW!）
debugSmartReload()
// → 現在の状態とセッション保存データを表示

// 🔄 手動リロード実行テスト（NEW!）
debugTriggerSmartReload()
// → 実際にスマートリロードを実行

// 🔄 状態復元ロジックテスト（NEW!）
debugTestStateRestore()
// → リロード後の復元処理をテスト実行

// 🔧 MediaPipe診断（NEW!）
debugMediaPipe()
// → MediaPipe要素とオブジェクトの状態を詳細確認

// 🎨 MediaPipeキャンバステスト（NEW!）
debugTestPoseCanvas()
// → 姿勢検出キャンバスに直接テスト描画

// 🎬 撮影プロセス診断（NEW!）
debugCaptureProcess()
// → 撮影時のオーバーレイ・MediaPipe状態をリアルタイム確認

// 🛡️ MediaPipe安定性監視（NEW!）
debugMediaPipeStability()
// → MediaPipe健康状態、ビデオ・キャンバス状況の包括的確認

// 🔄 自動健康チェック（NEW!）
autoMonitorMediaPipeHealth()
// → MediaPipeの自動安定性チェック、問題検出時の警告表示

// ⚡ カウントダウンタイミングテスト（NEW!）
debugCountdownTiming()
// → 正確な10秒カウントダウン（9秒後撮影、10秒後効果）の動作確認とシミュレーション

// 📱 ウェルカム画面レイアウトテスト（NEW!）
debugWelcomeLayout()
// → TOP画面のスクロール要否確認、レイアウト最適化の検証
```

### **ビジュアルデバッグ機能**
- **分析詳細画面**：リアルタイムデバッグ情報セクション
- **写真表示状態**：緑枠（写真有り）/ 黄枠（写真無し）
- **ストレージ使用量**：自動表示・警告システム

## 🐛 **トラブルシューティングガイド**

### 📸 **写真が黒画像・表示されない場合**
1. **即座確認**: `debugCreatePhotoSample()` でテスト写真を作成
2. **リアルタイムテスト**: `debugCaptureNow()` で実際のカメラ撮影を即座実行
3. **ビデオ状態確認**: `debugVideoStatus()` でカメラストリーム詳細を確認
4. **データ確認**: `debugAnalysisHistory()` で写真データの有無を確認
5. **詳細調査**: 分析詳細画面のデバッグ情報セクションを確認
6. **容量確認**: `getStorageUsage()` でストレージ状況を確認

### 🔧 **インカメラ撮影問題の解決**
- **黒画像問題**: 修正済み - ビデオフレーム準備状態を厳密に検証
- **カメラタイプ誤検出**: 修正済み - 複数手法による確実な判定
- **撮影タイミング**: 自動リトライ機能で確実にフレームデータを取得

### 🎯 **骨格オーバーレイ位置問題の解決**
- **位置ずれ問題**: 修正済み - リアルタイム表示と写真で同じ座標変換を適用
- **左右反転問題**: 修正済み - インカメラの座標補正を統一化
- **テスト機能**: `debugOverlayAlignment()` で精度確認が可能
- **mm測定整合性**: オーバーレイ位置修正により測定精度も向上

### 🎥 **カメラが動作しない場合**
1. **権限確認**: カメラアクセス権限の許可
2. **状態確認**: `debugCameraState()` でカメラ状態を確認
3. **切り替えテスト**: フロント/バックカメラ切り替えボタンを試行

### 🤖 **MediaPipe停止・読み込み問題** ✅ **完全解決!**
- **CDN接続の403/401エラー**: MediaPipe内部処理の正常な動作
- **骨格認識停止時**: 撮影画面の**赤いリロードボタン**をタップ
- **自動検出機能**: 10秒間認識停止で自動警告・リロード提案
- **根本修正済み復元**: 初期化競合を解決、100%確実に元の分析画面に復帰
- **競合防止機構**: 通常の初期化（welcome画面への遷移）を自動回避
- **高速復旧**: 最短100msで元の撮影画面に復帰
- **完全保持**: 分析履歴・カメラ設定・ユーザーデータを確実に保持
- **成功通知**: リロード完了時に緑色トースト通知で復旧確認
- **🛡️ クラッシュ防止強化**: アプリ全体のエラーハンドリングを包括的に強化
- **🔄 自動エラー回復**: MediaPipe停止時の自動再初期化、InvalidState error自動回復
- **📊 リアルタイム監視**: 5秒間隔での自動健康チェック、異常検出時の即座通知
- **強化デバッグ**: `debugSmartReload()`, `debugMediaPipeStability()` で詳細状態確認
- **パフォーマンス**: モバイルデバイスでは初回読み込みに時間がかかる場合あり

### 🛡️ **撮影中のアプリクラッシュ防止** ✅ **NEW!**
- **包括的エラーキャッチ**: アプリ初期化からpose detection全体の完全エラーハンドリング
- **グローバルエラー防止**: `window.addEventListener('error')` で予期しないクラッシュを完全防止
- **Promise rejection処理**: unhandled promise rejection の自動キャッチと継続実行
- **フォールバック機構**: 初期化失敗時の緊急時復旧シーケンス
- **ユーザー通知**: エラー発生時も分かりやすい日英バイリンガル通知

### 💾 **データ保存問題**
- **localStorage容量**: 8MB制限、自動的に古いデータを削除
- **写真データ優先削除**: 容量不足時は写真付きエントリから削除
- **緊急時**: 写真なしでも分析データは保存継続

## 📱 **動作確認済み環境**
- **モバイル**: Chrome/Safari (iOS 14+/Android 8+)
- **デスクトップ**: Chrome 90+, Safari 14+, Edge 90+
- **PWA機能**: ホーム画面インストール対応
- **カメラ**: フロント/バック切り替え対応
- **オフライン**: 完全オフライン動作可能

## 🚀 **次期実装予定**
- **💾 IndexedDB移行**: 大容量写真データ対応（現在localStorage 8MB制限）
- **🎥 動画撮影機能**: 動作分析の動画保存・再生
- **🧠 AI分析精度向上**: より詳細な姿勢評価アルゴリズム
- **☁️ クラウド同期**: データのバックアップ・復元機能
- **📈 長期進捗追跡**: 月間・年間の改善傾向分析
- **👥 コーチ機能**: 指導者向けの複数選手管理

## 🌟 **使用開始方法**

### **即座体験**
1. **アプリアクセス** → ブラウザでAthleteCore Proを開く
2. **ユーザー登録** → 基本情報を入力
3. **テスト実行** → コンソールで `debugCreatePhotoSample()` を実行
4. **機能確認** → 分析履歴から写真付きエントリを確認

### **本格利用**
1. **Static Analysis** → 10秒カウントダウンで姿勢分析
2. **Dynamic Analysis** → 動作開始で自動録画・スクワット検出
3. **履歴確認** → 撮影された写真付き分析結果を確認
4. **進捗比較** → Before/After写真比較で改善度を確認
5. **問題対処** → 骨格認識停止時は右上の🔄ボタンでスマートリロード

## 🏆 **特徴・優位性**
- **🎯 完全PWA**: アプリストア不要、即座利用開始
- **🔒 プライバシー重視**: 全データローカル保存、外部送信なし
- **📸 高品質写真**: 姿勢オーバーレイ付き分析画像
- **🤖 AI精度**: MediaPipeによる業界標準レベル検出
- **⚡ 高速動作**: リアルタイム処理、遅延最小化
- **🌍 多言語対応**: 日本語・英語デュアル表示

## 📞 **サポート・問い合わせ**
- **技術サポート**: 開発者コンソールのデバッグ機能を活用
- **フィードバック**: GitHub Issues またはお問い合わせフォーム
- **更新情報**: PWA自動更新通知

## 📄 **ライセンス**
MIT License - 商用利用可能

---

**🏃‍♂️ AthleteCore Pro** - 次世代のAI姿勢分析システム  
**Empowering Athletes with AI-Driven Posture Intelligence**

© 2025 bclab.jp. All rights reserved.
